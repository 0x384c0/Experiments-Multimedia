
Предисловие

Всем привет. Это экспериментальная поебень для засирания интернетов, вебм-тредов и просто домашнего втыкания в монитор. Получилась она большей частью случайно, как оно работает я сам не очень хорошо понимаю. Как я это сделал - тоже. Но эта хуйня умеет генерировать клипы.

Для начала надо определиться с материалом, который будем использовать. В качестве видео рекомендую юзать какие-то готовые клипы или что-то с большим количеством движения, на "медленных" сценах работает плохо. В качестве аудио тоже рекомендую что-то динамичное, на медленном звуке тоже работает не очень. Потому фактически, это можно считать ремиксером готовых клипов.

Все написанное тут создается под Linux, хотя в теории на винде тоже можно запилить после небольшого допила. Но у меня нет ни малейшего желания это делать. В конечном счете, проще поставить виртуалочку с прыщами.

Создание трейлера

Нарезки можно сделать самому из готовых фильмов. Для начала собираем из фильма статистику:

ffprobe movie.mkv -show_packets -print_format xml | grep video > stat

На выходе получим большую портянку с оффсетами кадров. Это не очень хороший способ получения данных по битрейту, так как где-то там еще звук, но в целом сойдет, звук обычно размазан равномерно.

Затем все это безобразие нарезаем:

rm frag-*.avi # Удаляем предыдущие фрагменты если они остались
perl 1.pl movie.mkv < stat

Тут мы просто скармливаем скрипту наш фильм и его файл статистики, на выходе оно насрет много-много файликов frag*.avi и в конце высрет trailer.avi состоящий из рандомной склейки всех этих фрагментов. Работает быстро, без переконвертации. Будте готовы к большому размеру промежуточных файлов. Какого-то хуя скрипт жрет целый гигабайт оперативы, я неебу почему. По желанию можно поправить параметры в начале скрипта. Если последовательность не понравилась - можно запустить еще раз, оно только трейлер переделает. Желающие могут сортировать файлы не рандомом, а скажем по размеру - больше ЭКШОНА получается.

В любом случае, у нас получается клип из наиболее ЭКШОНОВЫХ частей, его мы и будем дальше ремиксить. Клип получается несколько больше желаемых 5 минут, но это потом можно исправить.

Помните, можно сгенерить много разных трейлеров, отремиксить их, а потом в обычном видеоредакторе склеить наиболее удачные части, на выходе может получится вполне крутая AMV-шка. Ну или по крайней мере могут появится идеи для ручного создания, потому что часто "вот-вот-почти-круто-сука-блять-капельку-не-дотянул" - все это можно пофиксить руками в видеоредакторе.

Создание ремикса

Сначала распаковываем звук, поскольку быдлокод работает с несжатым звуком

ffmpeg -i music.mp3 -ar 44100 -ac 1 -f s16le - > sounding

Потом пережимаем этот звук, тут все по вкусу:

ffmpeg -f s16le -ar 44100 -ac 1 -i sounding  -ab 32000 -y out_audio.mp4

Если вы понимаете что делаете, то можете пропустить этот шаг и юзать оригинал. Я же это делаю, чтобы избежать возможных задержек из-за контейнера. По умолчанию у меня звук жмется в libaacplus, потому 32000 вполне достаточно, но вы можете жать во что угодно и с каким угодно битрейтом, а то и вообще не пережимать.

Ну и вот финальная строчка запуска:

rm a.out;gcc 1.c -lfftw3;ffmpeg -i trailer.avi -f rawvideo -pix_fmt rgb24 -s 320x240 - | ./a.out sounding | ffmpeg -s 320x240 -r 25 -pix_fmt rgb24 -f rawvideo -i - -i out_audio.mp4 -acodec copy -y new_cool_remix.mp4

Что тут происходит:
1. Удаляется бинарник (если он есть)
2. Компиляется бинарник из 1.с (если вы его изменили, а если нет - это недолго)
3. Засасывается trailer.avi и подается на вход бинарнику. Обрати внимание, что он ресайзится до 320х240, того размера, что указан внутри 1.с, если собираешься делать фуллхд - поправь WIDTH/HEIGHT в исходнике и эти же данные юзай тут.
4. Запуск самого фильтра с опцией sounding - того файла, что содержит распакованный звук
5. Сборка выхлопа вместе со звуком, на входе ТЕЖЕ параметры, что на выходе первого ffmpeg, остальное по вкусу.

Работает медленно, потому что тут сразу распаковка/упаковка видео. Требует много памяти, а именно около сотни метров для 320х240, если будете увеличивать - пропорционально вырастет объем требуемой оперативы, на холодильнике это лучше не запускать.

Если музыка слишком плавная или тебе охота больше дерганий, то можно раскомментить строчку diff_double=rms*255/32000; внутри 1.c и пересобрать. Желающие могут поиграть с коэфициентами, если разберутся что и за что отвечает.


Если трейлер получился длинней раза в 2 чем нужно, да и в целом он какой-то медленный, то его можно ускорить примерно так:

rm a.out;gcc 1.c -lfftw3;ffmpeg -i trailer.avi -f rawvideo -pix_fmt rgb24 -s 320x240 -filter:v "setpts=0.5*PTS" -r 25 - | ./a.out sounding (дальше как раньше)

В данном случае мы перемножаем PTS на 0.5, т.е. задержка между кадрами будет в 2 раза меньше, а следовательно и общая длительность будет меньше. В конце мы ставим -r 25 чтобы обрезать лишние кадры и сохранить 25 FPS. Работает медленно. Считать множитель просто: длинну аудио делим на длинну видео.

Если нет звука или черный экран вместо видео - проверьте пути до файлов.

Код писался на коленке за несколько часов, потому поставляется "как есть", на благо Анонимусов и анонимного клипмейкерства.

