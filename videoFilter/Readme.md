### Пишем быстрые и грязные фильтры видео

Порой нам надо как-то пофильтровать видео, быть может наложить сверху какой-то текст или график. Писать полноценное приложение, которое распакует видеопоток, впечает в изображение новые элементы или изменит само изображение, а потом сожмет поток заново, несколько сложно. Сегодня мы научимся быстро и грязно делать такие приложения без знаний о том, как вообще кодировать видео.

Для начала вспомним, что изображения состоят из строк и столбцов точек, которые называются пикселями. Каждая точка состоит обычно из 3 или 4 компонент, как правило это Красный, Зеленый и Синий сигналы, а еще иногда бывает Альфа-канал. Следовательно, чтобы изменить 1 точку изображения, нам надо изменить 3-4 компонены (это обычно 3-4 байта). Таким образом, чтобы изменить все изображение целиком, нам надо считать все строки и столбцы, в каждом по 3-4 элемента и как-то модифицировав их, сохранить обратно. К примеру, если у нас картинка размером 256х192 пикселя в формате RGB24, то значит она будет иметь 49152 точки и 147456 компонентов цвета (байт).

Следовательно, нам надо просто считывать кусочки по 147456 байт, как-то их модифицировать и записывать обратно! Это все! Никаких сложных библиотек или алгоритмов не требуется! Откуда же мы возмем эти байты? А их нам может отдать замечательная утилита ffmpeg и ее не менее замечательный режим rawvideo, выхлоп которого мы будем отдавать в stdout и принимать в stdin своего приложения!

[filter.c](filter.c)

Да, это все! Конечно, тут все константы захардкожены, никогда не делайте так в реальных проектах!

Теперь запустим это и подадим сюда видео:

`ffmpeg -i in.mp4 -s 256x192 -f rawvideo -pix_fmt rgb24 - | ./a.out | ffmpeg -s 256x192 -f rawvideo -pix_fmt rgb24 -i - -y out.mp4`

И мы получим такой результат:

out.mp4

Давайте разберем, какие параметры в этой строке участвовали:

`ffmpeg -i in.mp4 -s 256x192 -f rawvideo -pix_fmt rgb24 -`

Здесь мы читаем из файла in.mp4, ресайзим картинку до 256x192 (если ваше видео уже размером в 256x192, то можно этого не делать), затем указываем, что его надо сконвертировать в формат цвета rgb24 (если оно еще не в нем, на что могут тратиться достаточно большие ресурсы), а результат нам нужен в виде несжатого видео rawvideo, результат же мы записываем в -, т.е. в stdout.

`| ./a.out |`

А это наше приложение. Вертикальные "трубки" означают, что оно возмет данные от предыдущего приложения и передаст их в следующее

`ffmpeg -s 256x192 -f rawvideo -pix_fmt rgb24 -i - -y out.mp4`

Тут мы указываем, что на входе этого ffmpeg-а будет несжатое видео в формате rawvideo, размером 256x192 и в цветовом пространстве rgb24. Тут же желательно указать fps, так как он теряется от такой конвертации. Выход мы будем писать в out.mp4, причем даже если такой файл уже есть, за это отвечает параметр -y
